pipeline {
    agent any

    environment {
        CREDENTIAL_ID = env.JOB_NAME // Setting CREDENTIAL_ID to the current job name
    }

    stages {
        stage('Check Job Name and Generate Password') {
            steps {
                script {
                    // Check if the job name matches the credential ID
                    if (env.JOB_NAME != CREDENTIAL_ID) {
                        error "Job name does not match credential ID. Halting the pipeline."
                    } else {
                        echo "Job name matches credential ID. Proceeding with password generation."

                        // Generate a random password
                        def chars = ('A'..'Z') + ('a'..'z') + ('0'..'9') + '!@#$%^&*()'
                        def password = (1..12).collect { chars[new Random().nextInt(chars.size())] }.join()

                        // Store password in environment variable to pass to next stage
                        env.NEW_PASSWORD = password
                    }
                }
            }
        }

        stage('Update Jenkins Credential') {
            steps {
                script {
                    // Update Jenkins credential with the new password
                    def credentials = com.cloudbees.plugins.credentials.CredentialsProvider.lookupCredentials(
                        com.cloudbees.plugins.credentials.common.StandardUsernamePasswordCredentials.class,
                        Jenkins.instance,
                        null,
                        null
                    ).find { it.id == CREDENTIAL_ID }

                    if (credentials) {
                        def username = credentials.username

                        // Create new credentials with updated password
                        def updatedCredentials = new com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl(
                            credentials.scope,
                            CREDENTIAL_ID,
                            credentials.description,
                            username,
                            env.NEW_PASSWORD
                        )

                        // Update credential in Jenkins
                        def store = Jenkins.instance.getExtensionList(
                            'com.cloudbees.plugins.credentials.SystemCredentialsProvider'
                        )[0].getStore()
                        store.updateCredentials(
                            com.cloudbees.plugins.credentials.domains.Domain.global(),
                            credentials,
                            updatedCredentials
                        )

                        echo "Credential '${CREDENTIAL_ID}' updated successfully."
                    } else {
                        error "Credential with ID '${CREDENTIAL_ID}' not found."
                    }
                }
            }
        }
    }

    post {
        success {
            echo "Password update completed successfully."
        }
        failure {
            echo "Password update failed."
        }
    }
}
